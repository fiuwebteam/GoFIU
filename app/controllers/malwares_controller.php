<?php
class MalwaresController extends AppController {
	//---------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------
	var $name = 'Malwares';
	var $helpers = array('Javascript');
	//---------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------
	function update() {
		$api_key = "ABQIAAAAfglZhwglKGt8LvQ4eMdZ9RS1rXy6q0IE0oocnlD5XdUm7r4vDQ";
		$version = "goog-malware-hash";
		$google_url = "http://sb.google.com/safebrowsing/update";
		//open the remote URL
		$target = "$google_url?client=api&apikey=$api_key&version=$version:1:-1";
		$handle = fopen("$target", 'r')
			or die("Couldn't open file handle " . $target);
		//populate the db
		if ($handle) {
			set_time_limit(1200);
			$this->Malware->deleteAll('1 = 1', false);		
		    while (!feof($handle)) {
		        $line = fgets($handle);
		        //ignore the line [goog-malware-hash 1.14879]
		        if (substr($line,0,1) != '[') {
		        	$operation = (substr($line,0,1)); //get the '+' or '-'
		        	$hash = substr($line,1); //get the md5 hash
		        	if ($operation == '+') {
		        		$this->Malware->create();
		        		$this->Malware->save(array("malware_hash" => $hash));
		        	} 
		        }
		    }
		    fclose($handle);
		}
		$this->redirect(array('controller' => 'tinyurls', 'action' => 'index'));
	}
	//---------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------
}

?>